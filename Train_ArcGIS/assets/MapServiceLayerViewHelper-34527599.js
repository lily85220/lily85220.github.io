import{ac as g,ad as m,af as R,ah as $,aE as S,bK as V,W as F,aA as E,b6 as O,r as w,ba as P,ai as H,ms as I,bA as Q,v as T,mt as L,Q as U,mu as M,aH as z,mv as j,mw as q,aV as k,iI as D}from"./index-cb639cc1.js";import{s as G}from"./drapedUtils-8847b824.js";import{d as N,s as W}from"./popupUtils-fdf02f9f.js";let x=null;function ee(t,r){return r.type==="tile"||r.type==="map-image"}let d=class extends ${constructor(t){super(t),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=S(async r=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(r).catch(()=>{}))})}initialize(){const t=r=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(r).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([V(()=>this.highlightGraphics,"change",r=>t(r.added),{onListenerAdd:r=>t(r)})])}async fetchPopupFeatures(t,r){var a,o;const{layerView:{layer:e,view:{scale:i}}}=this;if(!t)throw new F("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:e});const s=C(e.sublayers,i,r);if(!s.length)return[];const n=await B(e,s);if(!((((o=(a=e.capabilities)==null?void 0:a.operations)==null?void 0:o.supportsIdentify)??!0)&&e.version>=10.5)&&!n)throw new F("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:e});return n?this._fetchPopupFeaturesUsingQueries(t,s,r):this._fetchPopupFeaturesUsingIdentify(t,s,r)}clearHighlights(){var t;(t=this.highlightGraphics)==null||t.removeAll()}highlight(t){const r=this.highlightGraphics;if(!r)return{remove(){}};let e=null;if(t instanceof E?e=[t]:O.isCollection(t)&&t.length>0?e=t.toArray():Array.isArray(t)&&t.length>0&&(e=t),e=e==null?void 0:e.filter(w),!e||!e.length)return{remove:()=>{}};for(const i of e){const s=i.sourceLayer;s!=null&&"geometryType"in s&&s.geometryType==="point"&&(i.visible=!1)}return r.addMany(e),{remove:()=>{r.removeMany(e??[])}}}async _updateHighlightedFeaturesSymbols(t){const{layerView:{view:r},highlightGraphics:e,highlightGraphicUpdated:i}=this;if(e&&i)for(const s of t){const n=s.sourceLayer&&"renderer"in s.sourceLayer&&s.sourceLayer.renderer;s.sourceLayer&&"geometryType"in s.sourceLayer&&s.sourceLayer.geometryType==="point"&&n&&"getSymbolAsync"in n&&n.getSymbolAsync(s).then(async a=>{var l;a||(a=new P);let o=null;const h="visualVariables"in n?(l=n.visualVariables)==null?void 0:l.find(u=>u.type==="size"):void 0;h&&(x||(x=(await H(()=>import("./index-cb639cc1.js").then(u=>u.xO),["assets/index-cb639cc1.js","assets/index-ec7d25bd.css"])).getSize),o=x(h,s,{view:r.type,scale:r.scale,shape:a.type==="simple-marker"?a.style:null})),o||(o="width"in a&&"height"in a&&a.width!=null&&a.height!=null?Math.max(a.width,a.height):"size"in a?a.size:16),e.includes(s)&&(s.symbol=new P({style:"square",size:o,xoffset:"xoffset"in a?a.xoffset:0,yoffset:"yoffset"in a?a.yoffset:0}),i(s,"symbol"),s.visible=!0)})}}async _updateHighlightedFeaturesGeometries(t){const{layerView:{layer:r,view:e},highlightGraphics:i,highlightGraphicUpdated:s}=this;if(this._highlightGeometriesResolution=t,!s||!(i!=null&&i.length)||!r.capabilities.operations.supportsQuery)return;const n=this._getTargetResolution(t),a=new Map;for(const l of i)if(!this._featuresResolutions.has(l)||this._featuresResolutions.get(l)>n){const u=l.sourceLayer;I(a,u,()=>new Map).set(l.getObjectId(),l)}const o=Array.from(a,([l,u])=>{const c=l.createQuery();return c.objectIds=[...u.keys()],c.outFields=[l.objectIdField],c.returnGeometry=!0,c.maxAllowableOffset=n,c.outSpatialReference=e.spatialReference,l.queryFeatures(c)}),h=await Promise.all(o);if(!this.destroyed)for(const{features:l}of h)for(const u of l){const c=u.sourceLayer,p=a.get(c).get(u.getObjectId());p&&i.includes(p)&&(p.geometry=u.geometry,s(p,"geometry"),this._featuresResolutions.set(p,n))}}_getTargetResolution(t){const r=t*Q(this.layerView.view.spatialReference),e=r/16;return e<=10?0:t/r*e}async _fetchPopupFeaturesUsingIdentify(t,r,e){const i=await this._createIdentifyParameters(t,r,e);if(T(i))return[];const{results:s}=await L(this.layerView.layer.parsedUrl,i);return s.map(n=>n.feature)}async _createIdentifyParameters(t,r,e){const{floors:i,layer:s,timeExtent:n,view:{spatialReference:a,scale:o}}=this.layerView,h=w(e)?e.event:null;if(!r.length)return null;await Promise.all(r.map(({sublayer:f})=>f.load().catch(()=>{})));const l=Math.min(U("mapservice-popup-identify-max-tolerance"),s.allSublayers.reduce((f,y)=>y.renderer?G({renderer:y.renderer,event:h}):f,2)),u=this.createFetchPopupFeaturesQueryGeometry(t,l),c=M(o,a),p=Math.round(u.width/c),b=new z({xmin:u.center.x-c*p,ymin:u.center.y-c*p,xmax:u.center.x+c*p,ymax:u.center.y+c*p,spatialReference:u.spatialReference});return new j({floors:i,gdbVersion:"gdbVersion"in s?s.gdbVersion:void 0,geometry:t,height:p,layerOption:"popup",mapExtent:b,returnGeometry:!0,spatialReference:a,sublayers:s.sublayers,timeExtent:n,tolerance:l,width:p})}async _fetchPopupFeaturesUsingQueries(t,r,e){const{layerView:{floors:i,timeExtent:s}}=this,n=w(e)?e.event:null,a=r.map(async({sublayer:o,popupTemplate:h})=>{if(await o.load().catch(()=>{}),o.capabilities&&!o.capabilities.operations.supportsQuery)return[];const l=o.createQuery(),u=G({renderer:o.renderer,event:n}),c=this.createFetchPopupFeaturesQueryGeometry(t,u);if(l.geometry=c,l.outFields=await N(o,h),l.timeExtent=s,i){const v=i.clone(),_=q(v,o);w(_)&&(l.where=l.where?`(${l.where}) AND (${_})`:_)}const p=this._getTargetResolution(c.width/u),b=await K(h),f=o.geometryType==="point"||b&&b.arcadeUtils.hasGeometryOperations(h);f||(l.maxAllowableOffset=p);let{features:y}=await o.queryFeatures(l);const A=f?0:p;y=await J(o,y);for(const v of y)this._featuresResolutions.set(v,A);return y});return(await k(a)).reverse().reduce((o,h)=>h.value?[...o,...h.value]:o,[]).filter(o=>o!=null)}};function C(t,r,e){const i=[],s=n=>{const a=n.minScale===0||r<=n.minScale,o=n.maxScale===0||r>=n.maxScale;if(n.visible&&a&&o){if(n.sublayers)n.sublayers.forEach(s);else if(n.popupEnabled){const h=W(n,{...e,defaultPopupTemplateEnabled:!1});w(h)&&i.unshift({sublayer:n,popupTemplate:h})}}};return((t==null?void 0:t.toArray())??[]).reverse().map(s),i}function K(t){var r;return(r=t.expressionInfos)!=null&&r.length||Array.isArray(t.content)&&t.content.some(e=>e.type==="expression")?D():Promise.resolve()}async function B(t,r){var e,i;if((i=(e=t.capabilities)==null?void 0:e.operations)!=null&&i.supportsQuery)return!0;try{return await Promise.any(r.map(({sublayer:s})=>s.load().then(()=>s.capabilities.operations.supportsQuery)))}catch{return!1}}async function J(t,r){const e=t.renderer;return e&&"defaultSymbol"in e&&!e.defaultSymbol&&(r=e.valueExpression?await Promise.all(r.map(i=>e.getSymbolAsync(i).then(s=>s?i:null))).then(i=>i.filter(s=>s!=null)):r.filter(i=>e.getSymbol(i)!=null)),r}g([m({constructOnly:!0})],d.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),g([m({constructOnly:!0})],d.prototype,"layerView",void 0),g([m({constructOnly:!0})],d.prototype,"highlightGraphics",void 0),g([m({constructOnly:!0})],d.prototype,"highlightGraphicUpdated",void 0),g([m({constructOnly:!0})],d.prototype,"updatingHandles",void 0),d=g([R("esri.views.layers.support.MapService")],d);export{ee as P,d as S};
