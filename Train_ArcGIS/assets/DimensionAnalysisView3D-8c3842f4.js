import{v as g,r5 as Dt,r6 as At,r as p,n as C,bn as z,ct as _,dA as zt,bb as De,cy as Ue,bm as Be,kd as je,og as k,cJ as j,bx as L,bL as nt,dQ as K,bC as Rt,cD as Ae,bs as ce,dO as Q,r7 as Ne,bW as Ht,c_ as we,ac as d,ad as c,af as F,ah as ae,a0 as ze,a1 as ie,a3 as S,cT as R,jo as kt,ak as st,bf as G,d7 as Vt,jR as Pe,bB as oe,cv as Z,bc as q,l5 as be,cV as Ce,cW as $e,bt as at,ja as We,jE as ot,kn as Lt,bw as rt,cM as lt,k as dt,B as H,cz as ue,r8 as Et,cU as It,bl as Gt,r9 as Ft,e7 as qe,a4 as pe,b6 as Re,ra as Ut,rb as Bt,rc as jt,bd as me,rd as Nt,c$ as Wt,k5 as he,bZ as D,dc as Oe,bS as qt,dK as Kt,dM as Ke,cN as He,re as Te,c2 as Y,i7 as Jt,ay as Yt,ck as Xt,e4 as Je,rf as Qt,X as Zt,rg as ei,bY as ti,cs as ii,c0 as ni,rh as ct,lR as si,c5 as ai,N as Ye,ri as oi,rj as ri,rk as J,qV as li,bJ as di,bK as Xe,a2 as Qe}from"./index-cb639cc1.js";import{n as ci}from"./AnalysisView3D-e2ceb63d.js";import{t as y,r as ui,u as pi}from"./LengthDimension-ff94a894.js";import{v as ut,i as mi,g as hi}from"./quantityFormatUtils-018bdc61.js";import{f as N,g as gi}from"./Segment-81cd44da.js";import{j as fi,y as _i}from"./euclideanLengthMeasurementUtils-7df7c9ce.js";import{N as yi,i as pt,e as ee,x as mt,U as vi,D as Si,C as Mi,V as ke}from"./manipulatorUtils-628928f4.js";import{B as wi,C as ht,z as Ve,o as Pi}from"./Factory-e452a86d.js";import{x as re,w as Le,U as bi}from"./InteractiveToolBase-2426985e.js";import{_ as Ci,x as $i}from"./VerticesVisualElement-77218424.js";import{g as U,n as Oi,a as Ti,b as xi}from"./LineVisualElement-78cd90ab.js";import{c as Di}from"./ImageMaterial-16df11df.js";import{V as Ai,g as zi,w as Ri}from"./EditGeometryOperations-db5a0065.js";import{e as Hi}from"./SnappingContext-4110407b.js";import{h as ki,m as Vi}from"./SnappingOperation-505d6431.js";import{a as Li,s as Ei,m as Ii,c as Gi}from"./analysisViewUtils-8e8822f7.js";import{r as Fi}from"./RenderTexture-0f2142b8.js";import"./TextOverlayItem-5acee2ee.js";import"./measurementUtils-999dc2c1.js";import"./drawUtils-c430a3a5.js";import"./RightAngleQuadVisualElement-97d8d566.js";import"./VisualElementResources-0bf527a0.js";import"./PointVisualElement-436a9da2.js";import"./colorUtils-7641d345.js";import"./PointSnappingHint-b85cbba9.js";import"./dehydratedFeatureComparison-3c65c83d.js";function Ui(e,t,i){if(g(e))return null;const n=e.dimensionSegment.startRenderSpace,s=e.dimensionSegment.endRenderSpace,a=fi(n,s,e.spatialReference);if(g(a))return null;const o=t===y.Vertical?Dt(a.value,a.unit,i):At(a.value,a.unit,i);return ut(a,o)}function ge(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:s,orientation:a}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,offset:n,measureType:s,orientation:a}}function fe({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:n,orientation:s},a,o=null){if(g(e)||g(t))return null;const l=ft(p(o)?o.directSegment:new N,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},a),r=p(o)?o.primaryOffsetAxis:C();ye(r,{measureType:n,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:l,orientation:s,renderCoordsHelper:a});const u=p(o)?o.dimensionSegment:new N;return Ee({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&n===y.Vertical?(z(u.startRenderSpace,l.startRenderSpace),z(u.endRenderSpace,l.endRenderSpace)):_t(u,{offsetAxis:r,offset:i,relativeToSegment:l,renderCoordsHelper:a}),{directSegment:l,dimensionSegment:u,primaryOffsetAxis:r,spatialReference:a.spatialReference}}function Ze(e,t,i,n){return t===ne.Start?(z(e.startRenderSpace,i.startRenderSpace),z(e.endRenderSpace,n.startRenderSpace)):(z(e.startRenderSpace,i.endRenderSpace),z(e.endRenderSpace,n.endRenderSpace)),e}var ne;function Bi(e,t,i,n){ce(e.startRenderSpace,t.startRenderSpace,i,n),ce(e.endRenderSpace,t.endRenderSpace,i,n)}function gt(e,t,i,n){switch(t){case y.Direct:return ft(e,i,n);case y.Horizontal:case y.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,dimension:o,geometry:l}=i;let r;o.measureType===y.Direct?(r=ji(l,n)===s.z>a.z,t===y.Horizontal&&(r=!r)):r=!Ni(l);const[u,m]=r?[s,a]:[a,s],h=Q(m,Wi);return t===y.Horizontal?h.z=u.z:(h.x=u.x,h.y=u.y),n.toRenderCoords(u,e.startRenderSpace),n.toRenderCoords(h,e.endRenderSpace),e}}}function ft(e,t,i){return i.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),i.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}function ji(e,t){const i=e.directSegment.eval(.5,_.get()),n=t.worldUpAtPosition(i,_.get()),s=e.dimensionSegment.eval(.5,_.get()),a=k(_.get(),s,i);return!nt(a,K)&&L(a,n)>0}function Ni(e){const{startRenderSpace:t,endRenderSpace:i}=e.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=e.directSegment;return Ne(n,t)<Ne(s,i)}(function(e){e[e.Start=0]="Start",e[e.End=1]="End"})(ne||(ne={}));const Wi=Ht(0,0,0,null);function qi(e,t,i,n){const{directSegment:s}=i,a=ye(_.get(),{measureType:t,directSegment:s,renderCoordsHelper:n}),o=_t(Ki,{offsetAxis:a,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,_.get()),l=k(_.get(),e,o);return L(l,a)*n.unitInMeters}const Ki=new N;function ye(e,t){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:a,endRenderSpace:o},directSegment:l,renderCoordsHelper:r}=t,u=l.eval(.5,_.get()),m=r.worldUpAtPosition(u,_.get()),h=r.worldBasisAtPosition(u,zt.Y,_.get());switch(i){case y.Horizontal:z(e,m);break;case y.Vertical:L(a,m)<L(o,m)?k(e,o,a):k(e,a,o),j(e,e,m),j(e,e,m);break;case y.Direct:{const f=De(t.orientation,0);if(Ee({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))Ue(le,-Be(f),m),je(e,h,le);else{const w=k(_.get(),o,a),P=j(_.get(),w,m);j(P,P,w),Ue(le,Be(f),w),je(e,P,le)}break}}return nt(e,K)?z(e,h):Rt(e,e)}const le=Ae();function Ee({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return p(e)&&p(t)&&e.x===t.x&&e.y===t.y}function _t(e,t){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:a},relativeToSegment:o,renderCoordsHelper:l}=t,r=n/l.unitInMeters,[u,m]=Ji(s,a,i,r);return ce(e.startRenderSpace,o.startRenderSpace,i,u),ce(e.endRenderSpace,o.endRenderSpace,i,m),e}function Ji(e,t,i,n=0){const s=L(t,i),a=L(e,i),o=Math.abs(s-a)+n;return s>a?[o,n]:[n,o]}function ve(e,t,i){const n=t.directSegment.eval(.5,_.get());return i.worldUpAtPosition(n,e)}function Ie(e,t){const{startRenderSpace:i,endRenderSpace:n}=t.directSegment;return k(e,n,i)}function Ge(e,t,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=t.dimensionSegment;return i.invert?k(e,n,s):k(e,s,n)}function xe(e,t){const i=e.directSegment.eval(.5,_.get());return t.headingAtPosition(i,e.primaryOffsetAxis)}function Yi(e,t){return we(Ge(Xi,e))/t**2}const Xi=C();function yt(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i}=e;if(g(t)||g(i))return!1;const n=_i(t,i);return p(n)&&ut(n,"meters").value>vt}const vt=1e5;function se(e){return p(e.geometry)}let B=class extends ae{constructor(t){super(t),this._handles=new ze}initialize(){const{computations:t}=this.analysisViewData;for(const i of t)this._addComputation(i);this.addHandles(t.on("change",({added:i,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of i)this._addComputation(s)}))}destroy(){this._handles=ie(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return mi(this.view)}_addComputation(t){this._handles.has(t)||this._handles.add(S(()=>ge(t),i=>{const{measureType:n}=i;if(yt(i)&&n!==y.Direct){const a=Math.round(kt(vt,"meters","kilometers"));return st.getLogger(this.declaredClass).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${a} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const s=fe(i,this.view.renderCoordsHelper,t.geometry);t.geometry=s,t.result.length=Ui(s,n,this._defaultUnit)},R),t)}_removeComputation(t){this._handles.remove(t)}};d([c({constructOnly:!0})],B.prototype,"analysisViewData",void 0),d([c({constructOnly:!0})],B.prototype,"view",void 0),d([c()],B.prototype,"analysis",null),d([c()],B.prototype,"_defaultUnit",null),B=d([F("esri.views.3d.analysis.Dimension.support.DimensionController")],B);const St={main:new G([255,127,0])};let Qi=class{constructor(){this.color=St.main,this.opacity=.5,this.radius=5}};class Zi{constructor(){this.color=new G([127,127,127]),this.opacity=.5,this.radius=5}}let en=class{constructor(){this.lineSizeFraction=.8}},tn=class{constructor(){this.color=St.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}};class nn{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}}let sn=class{constructor(){this.lineSizeFraction=.25}},an=class{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}};class on{constructor(){this.color=new G([255,127,0,.5])}}let rn=class{constructor(){this.pointManipulators=new Qi,this.offsetManipulator=new tn,this.orientationManipulator=new nn,this.markers=new en,this.labels=new an,this.offsetLine=new sn,this.constraint=new on,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Zi,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}};const v=new rn;class ln{constructor(t){this.start=t.start,this.end=t.end,this.offset=t.offset,this.heading=t.heading,this.rotation=t.rotation,this.direct=t.direct,this.horizontal=t.horizontal,this.vertical=t.vertical}manipulatorName(t){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&t===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(t){for(const i of ui)t(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(t){switch(t){case y.Direct:return this.direct;case y.Horizontal:return this.horizontal;case y.Vertical:return this.vertical}}}function dn(e,t){const i=yi(e,G.toUnitRGB(v.pointManipulators.color),v.pointManipulators.opacity,V);return i.available=!1,i.grabCursor="crosshair",i.radius=v.pointManipulators.radius,i.metadata=t.metadata,i.collisionPriority=1,i}function cn(e,t){const i=[ue(-.5,0,0),ue(.5,0,0)],{lengthFraction:n}=v.offsetManipulator,s=Pe(t.unfocusedMaterial,i.map(o=>oe(C(),o,n))),a=s.instantiate({material:t.focusedMaterial});return new pt({view:e,renderObjects:[new ee(s,Z.Unfocused|Z.Selected|V),new ee(a,Z.Focused|V)],collisionType:{type:"line",paths:[i]},radius:Fe(t.lineSizePt)/2,metadata:t.metadata,available:!1,...mt})}function Mt(e,{lineSizePt:t,material:i}){const{calloutOffsetPx:n,calloutOpacity:s,calloutWidth:a,discScale:o,focusMultiplier:l}=v.orientationManipulator;return{calloutLength:.25*Et*v.markers.lineSizeFraction*H(t)+n,calloutOpacity:s,calloutWidth:a,customStateMask:V,discScale:o,focusMultiplier:l,material:i,metadata:e}}function et(e,t){return vi(e,Mt(t.metadata,t))}function tt(e,t){Si(e,Mt(e.metadata,t))}function un(e,t){const i=[ue(-.5,0,0),ue(.5,0,0)],{lengthFraction:n}=v.offsetManipulator,s=Pe(t.thinOffsetManipulatorMaterial,i),a=Pe(t.unfocusedMaterial,i.map(l=>oe(C(),l,n))),o=a.instantiate({material:t.focusedMaterial});return new pt({view:e,renderObjects:[new ee(a,Z.Unfocused|V),new ee(o,Z.Focused|V),new ee(s,V)],collisionType:{type:"line",paths:[i]},radius:Fe(t.lineSizePt)/2,available:!1,metadata:t.metadata,...mt})}function pn(e,{isStart:t,createSnappingPipelineStep:i,dimension:n,onUpdate:s,view:a}){const o=t?"startPoint":"endPoint";return[re(e,(r,u,m,h)=>{const f=Ve(r),{snappingStep:w,cancelSnapping:P}=i(h);m=m.next(f).next(Le(n,[o,"measureType","orientation"])).next(P),u.next(f).next(wi(a)).next(...w).next(O=>{const M=Q(O.mapEnd,new q);s(o==="startPoint"?{startPoint:M}:{endPoint:M})})})]}function mn(e,{computation:t,view:i}){return[re(e,(n,s,a)=>{if(!se(t)||!n.selected)return;const{geometry:o,dimension:l}=t,r=Ve(n);s.next(r).next(Pt(i,l,o.dimensionSegment,o.primaryOffsetAxis)),a.next(r).next(Le(l,["offset"]))})]}function hn(e,{computation:t,view:i}){return[re(e,(n,s,a)=>{wt({cancel:a,computation:t,settingHeading:!0,steps:s,view:i})})]}function gn(e,{computation:t,view:i}){return[re(e,(n,s,a)=>{wt({cancel:a,computation:t,settingHeading:!1,steps:s,view:i})}),e.events.on("immediate-click",n=>{fn(n,t,i)})]}function fn(e,t,i){const{dimension:n,geometry:s}=t;if(n.orientation===90||n.orientation===270)return n.orientation=0,void e.stopPropagation();if(g(s))return;const{renderCoordsHelper:a}=i,o=fe({...ge(t),orientation:90},a),l=fe({...ge(t),orientation:270},a);if(g(o)||g(l))return;const r=xe(o,a),u=xe(l,a),m=bt(s,i),h=be.shortestSignedDiff(m,r),f=be.shortestSignedDiff(m,u);n.orientation=Math.abs(h)<Math.abs(f)?90:270,e.stopPropagation()}function wt(e){const{cancel:t,computation:i,settingHeading:n,steps:s,view:a}=e;if(!se(i))return;const{renderCoordsHelper:o}=a,{dimension:l,geometry:r}=i,u=C(),m=$t(C(),r,r.directSegment,o),h=Ot(_.get(),{forHeading:n,geometry:r,renderCoordsHelper:o}),f=Ce(m,h,$e()),w=De(l.orientation,n?()=>xe(r,a.renderCoordsHelper):0);s.next(ht(a,f)).next(P=>{P.action==="start"&&z(u,P.renderStart);const O=It(f),M=Mi(u,P.renderEnd,m,O);let E=w-Gt(M);n||(E=_n(E)),l.orientation=E}),t.next(Le(l,["orientation"]))}function _n(e){const t=be.normalize(e)%90;return t<v.orientationSnapThresholdDegrees?e-t:90-t<v.orientationSnapThresholdDegrees?e+(90-t):e}function yn(e,{computation:t,manipulatorMeasureType:i,view:n}){let s=y.Direct,a=0,o=0;return[e.events.on("grab-changed",l=>{if(l.action!=="start"||!se(t))return;const{dimension:r,geometry:u}=t;s=r.measureType,a=r.offset,o=r.orientation;const m=z(_.get(),e.renderLocation);r.measureType=i,r.offset=qi(m,i,u,n.renderCoordsHelper),r.orientation=0}),re(e,(l,r,u)=>{if(!se(t))return;const{geometry:m,dimension:h}=t,{renderCoordsHelper:f}=n,w=gt(Tt,i,t,f),P=ye(_.get(),{measureType:i,directSegment:m.directSegment,renderCoordsHelper:f}),O=Ve(l);r.next(O).next(Pt(n,h,w,P)),u.next(O).next(M=>(h.measureType=s,h.offset=a,h.orientation=o,M))})]}function Pt(e,t,i,n){const s=at(_.get(),i.endRenderSpace,i.startRenderSpace);j(s,s,n);const a=Ce(i.startRenderSpace,s,$e()),o=Ce(i.startRenderSpace,n,$e()),l=t.offset;let r,u=0;const m=new bi;return m.next(ht(e,a)).next(h=>{h.action==="start"&&(u=We(o,h.renderStart));const f=(We(o,h.renderEnd)-u)*e.renderCoordsHelper.unitInMeters;t.offset=l+f,r=h}),h=>(m.execute(h),r)}function bt(e,t){const{directSegment:i}=e,{renderCoordsHelper:n}=t,s=ve(_.get(),e,n),a=Ie(_.get(),e),o=j(_.get(),a,s),{viewForward:l}=t.state.camera;L(o,l)>0&&oe(o,o,-1);const r=i.eval(.5,_.get());return n.headingAtPosition(r,o)}function vn(e,t,i){const{dimensionSegment:n,primaryOffsetAxis:s}=t,a=Ge(te,t),o=ot(a,K)?Lt(_e):ke(a,s,K,_e),l=Math.max(rt(a),v.offsetManipulator.minLengthMeters/i.unitInMeters);lt(o,o,dt(te,l,l,l)),e.modelTransform=o,e.renderLocation=n.eval(.5,te)}function Sn(e,t,i){Ct(e,t,i,{forHeading:!0})}function Mn(e,t,i){Ct(e,t,i,{forHeading:!1})}function Ct(e,t,i,{forHeading:n}){const{dimension:s,geometry:a}=t,{primaryOffsetAxis:o}=a,l=oe(wn,o,s.offset>=0?1:-1),r=Ot(Pn,{forHeading:n,geometry:a,renderCoordsHelper:i});j(r,r,l);const u=ke(l,r,K,_e);e.modelTransform=u,e.renderLocation=$t(te,a,a.dimensionSegment,i)}const wn=C(),Pn=C();function bn(e,t,i,n){const{geometry:s}=t,a=gt(Tt,i,t,n),o=ye(te,{measureType:i,directSegment:s.directSegment,renderCoordsHelper:n}),l=k(Se,a.endRenderSpace,a.startRenderSpace),r=ke(l,o,K,_e),u=rt(l);lt(r,r,dt(Se,u,u,u)),e.modelTransform=r,e.renderLocation=a.eval(.5,Se)}function $t(e,t,i,n){const{startRenderSpace:s,endRenderSpace:a}=i,o=Cn(t,n)?s:a;return z(e,o)}function Ot(e,{forHeading:t,geometry:i,renderCoordsHelper:n}){return t?ve(e,i,n):Ge(e,i,{invert:!0})}function Cn(e,t){const i=Ie($n,e),n=ve(On,e,t);return L(i,n)>0}const $n=C(),On=C();function Tn(e){return H(e)+v.offsetManipulator.linePaddingPx}function Fe(e){return H(e)+v.offsetManipulator.focusedLinePaddingPx}const V=Vt.Custom1,te=C(),Se=C(),_e=Ae(),Tt=new N;function xn(e){let t,i,n=[],s=!1;function a(...o){return s&&t===this&&Dn(o,n)||(i=e.apply(this,o),t=this,n=o,s=!0),i}return a}function Dn(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}var A;function An(e,t){return{enabled:t.effectiveFeatureEnabled,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,geometry:e.geometry}}function zn(e,t){if(yt(e))return A.Direct;if(!e.enabled)return null;const{geometry:i}=e;if(g(i)||ot(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=v,{camera:s}=t.state,a=ve(_.get(),i,t.renderCoordsHelper),o=Ie(_.get(),i),l=oe(_.get(),a,L(o,a)),r=at(_.get(),o,l),u=we(r),m=we(l),{startRenderSpace:h,endRenderSpace:f}=i.directSegment,w=Math.max(s.computeRenderPixelSizeAt(h)*n,s.computeRenderPixelSizeAt(f)*n)**2;return u<w?A.Vertical:m<w?A.Horizontal:null}function Rn(e,t,{constraint:i,view:n}){const{unconstrainedGeometry:s}=e;if(g(s))return;const{renderCoordsHelper:a,spatialReference:o}=n,{startRenderSpace:l,endRenderSpace:r}=s.directSegment,u=a.fromRenderCoords(l,new q,o),m=a.fromRenderCoords(r,new q,o);let h;h=t==="start"?{startPoint:u}:{endPoint:m},xt(e,h,{constraint:i,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,unconstrainedGeometry:s,view:n})}function xt(e,t,i){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,unconstrainedGeometry:o,view:l}=i,{dimension:r,previousConstraint:u,preConstraintProperties:m}=e;if(g(s)||g(a))return;const h=()=>{"startPoint"in t?r.startPoint=t.startPoint:"endPoint"in t&&(r.endPoint=t.endPoint)};if(g(n))h(),p(u)&&p(m)&&(r.measureType=m.measureType,r.orientation=m.orientation);else switch(r.measureType=y.Direct,n){case A.Horizontal:if(n!==u&&(r.orientation=0),"startPoint"in t){const f=t.startPoint;p(f)&&(f.z=a.z),r.startPoint=f}else if("endPoint"in t){const f=t.endPoint;p(f)&&(f.z=s.z),r.endPoint=f}break;case A.Vertical:if(n!==u&&(r.orientation=bt(o,l)),"startPoint"in t){const f=t.startPoint;p(f)&&(f.x=a.x,f.y=a.y),r.startPoint=f}else if("endPoint"in t){const f=t.endPoint;p(f)&&(f.x=s.x,f.y=s.y),r.endPoint=f}break;case A.Direct:n!==u&&p(m)&&(r.orientation=m.orientation),h()}e.previousConstraint=n,e.unconstrainedGeometry=o}(function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Direct=2]="Direct"})(A||(A={}));function Hn(e,t){const i=new Ft({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(t==null?void 0:t.distance)??qe.distance,touchSensitivityMultiplier:(t==null?void 0:t.touchSensitivityMultiplier)??qe.touchSensitivityMultiplier});return{...S(()=>{var n,s;return((s=(n=e.map)==null?void 0:n.allLayers)==null?void 0:s.toArray())??[]},n=>{i.featureSources=new Re(n.map(s=>new Ut({layer:s,enabled:!0})))},pe),options:i}}const de=new Map;function kn(e){if(!de.has(e)){const n=Hn(e,{distance:10}),s=Ln(e,n.options);de.set(e,{referenceCount:0,snappingManager:s,remove:()=>{n.remove(),s.destroy()}})}const t=de.get(e);t.referenceCount++;const i=me(()=>Vn(e,t));return{snappingManager:t.snappingManager,...i}}function Vn(e,t){t.referenceCount--,t.referenceCount>0||Nt(()=>{t.referenceCount===0&&(t.remove(),de.delete(e))})}function Ln(e,t){return new Bt({view:e,options:t,snappingEnginesFactory:(i,n)=>[new jt({view:e,spatialReference:e.spatialReference,options:n})]})}let b=class extends Wt{constructor(e){super(e),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new ze,this._getSnappingContext=xn(i=>new Hi({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new Ai(new zi("point",Ri(!0,!1,this.view.spatialReference))),visualizer:new $i})),this._snappingManagerResult=kn(e.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=Me(),this._focusedOffsetManipulatorMaterial=Me(),this._thinOffsetManipulatorMaterial=Me(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:he(2)}),this._constraintSnappingIndicator=new U({view:e.view,attached:!0,width:1,color:G.toUnitRGBA(v.constraint.color),renderOccluded:D.OccludeAndTransparent,stipplePattern:he(5)});const t=G.toUnitRGBA(v.disabledPointIndicator.color);t[3]*=v.disabledPointIndicator.opacity,this._stagedStartIndicator=new Ci({view:e.view,attached:!1,color:t,size:2*v.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:e.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:D.OccludeAndTransparent})}initialize(){this._snappingOperation=new ki({view:this.view}),this._orientationManipulatorTexture=Pi(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new Di({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:D.Opaque});const{computations:e}=this.analysisViewData;for(const t of e)this._addComputation(t);this.addHandles([e.on("after-add",t=>this._addComputation(t.item)),e.on("after-remove",t=>this._removeComputation(t.item))]),this.addHandles([S(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:t,stagedComputation:i})=>{if(g(i)||g(t))return;const n=Q(t,new q);this._applyPointUpdate(i,{endPoint:n})},Oe),S(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(t,i)=>{const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=t;if(n===(i==null?void 0:i.stagedDimension)&&a===(i==null?void 0:i.firstGrabbedManipulator)){for(const o of[s,i==null?void 0:i.selectedComputation])if(p(o)){const l=this._computationManipulators.get(o);this._updateManipulators(o,l,t)}}else for(const[o,l]of this._computationManipulators)this._updateManipulators(o,l,t)},R),S(()=>this.analysis.style.lineSize,t=>{this._updateManipulatorStyle(t)},pe),S(()=>this.view.state.camera,()=>{p(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),S(()=>qt(this._stagedComputation,t=>{const i=t.elevationAlignedStartPoint,n=C();return p(i)&&this.view.renderCoordsHelper.toRenderCoords(i,n)?n:null}),t=>{p(t)?(this._stagedStartIndicator.vertices=[t],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Kt(this,()=>{const t=this._activeComputation,i=this._stagedComputation;if(g(t)||p(i)){const n=De(this.view.inputManager.latestPointerType,"mouse"),s=this._getSnappingContext(n);this.updatingHandles.addPromise(Ke(this._snappingOperation.resnap(this._snappingManager,s)))}if(p(t)){const{start:n,end:s}=this._computationManipulators.get(t);if(n.grabbing||s.grabbing){const a=n.grabbing?"start":"end",o=this._computeConstraint(t);Rn(t,a,{constraint:o,view:this.view})}}})}destroy(){this._snappingOperation=ie(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(p(this._stagedComputation))return this._stagedComputation;const{selectedComputation:e}=this.analysisViewData;return this.hasGrabbedManipulators&&p(e)?e:null}get _stagedComputation(){const e=this._stagedDimension,t=this.analysisViewData.computations.at(-1);return g(e)||g(t)||t.dimension!==e?null:t}get _constraintHandles(){return[He(()=>this.analysisViewData.selectedComputation,e=>{e.previousConstraint=this._computeConstraint(e)},{...R,equals:Te}),S(()=>{const e=this._activeComputation;if(g(e))return null;const{measureType:t,orientation:i}=e.dimension;return{measureType:t,orientation:i,computation:e}},(e,t)=>{if(p(e)&&g(t)){const{measureType:i,orientation:n,computation:s}=e;switch(s.previousConstraint){case A.Horizontal:s.preConstraintProperties={measureType:y.Horizontal,orientation:0};break;case A.Vertical:s.preConstraintProperties={measureType:y.Vertical,orientation:0};break;case A.Direct:s.preConstraintProperties={measureType:y.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:i,orientation:n}}}g(e)&&p(t)&&(t.computation.preConstraintProperties=null)},Oe)]}get _snappingIndicatorHandles(){const e="snapping-indicator-event-handles";return[S(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:t,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(e),g(i))n.attached=!1;else if(i===t)n.attached=!0;else{const{start:s,end:a}=this._computationManipulators.get(i),o=()=>{n.attached=s.grabbing||a.grabbing};o(),this.addHandles([s.events.on("grab-changed",o),a.events.on("grab-changed",o)],e)}}),S(()=>{const t=this._activeComputation;return p(t)?{geometry:t.geometry,constraint:t.previousConstraint}:{}},({geometry:t,constraint:i})=>{const n=this._constraintSnappingIndicator;p(t)&&p(i)&&i!==A.Direct?(n.visible=!0,n.setGeometryFromSegment(t.directSegment)):n.visible=!1})]}removeStaged(){return!!p(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(e){const{_stagedDimension:t}=this;if(g(t)){const i=this._onUnstagedClick(e);return this.analysis.dimensions.add(i),null}return this._onStagedClick(e),t}onPointerMove({mapPoint:e,pointerType:t}){if(t==="touch")return;const i=this._getSnappingContext(t);this.updatingHandles.addPromise(Ke(this._snappingOperation.snap({point:e},this._snappingManager,i)))}onManipulatorSelectionChanged(){p(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:e,pointerType:t}){let i=e;if(t==="mouse"){const s=this._getSnappingContext(t);i=this._snappingManager.update({point:e,context:s})}const n=new pi({startPoint:Q(i,new q),endPoint:null,measureType:y.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:e,pointerType:t}){const i=this._stagedComputation;if(g(i))return;let n=e;if(t==="mouse"){const a=this._getSnappingContext(t);n=this._snappingManager.update({point:e,context:a})}const s=Q(n,new q);this._applyPointUpdate(i,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(e){if(this._computationManipulators.has(e))return;const t=this._setupPointManipulator(e,{isStart:!0}),i=this._setupPointManipulator(e,{isStart:!1}),n=this._setupOffsetManipulator(e),s=this._setupHeadingManipulator(e),a=this._setupRotationManipulator(e),o=this._setupMeasureTypeManipulator(e,y.Direct),l=this._setupMeasureTypeManipulator(e,y.Horizontal),r=this._setupMeasureTypeManipulator(e,y.Vertical),u=new ln({start:t,end:i,offset:n,heading:s,rotation:a,direct:o,horizontal:l,vertical:r});this._setupComputationToManipulatorsSync(e,u),this._computationManipulators.set(e,u),this.manipulators.addMany(u.values())}_removeComputation(e){const t=this._computationManipulators.get(e);if(!g(t)){this._computationHandles.remove(e),this._computationManipulators.delete(e);for(const i of t.values())this.manipulators.remove(i)}}_setupComputationToManipulatorsSync(e,t){this._computationHandles.add([S(()=>e.geometry,()=>this._updateManipulators(e,t),{...R,equals:Te})],e)}_setupPointManipulator(e,t){const{view:i}=this,{dimension:n}=e,s=dn(i,{metadata:n}),a=pn(s,{isStart:t.isStart,createSnappingPipelineStep:o=>Vi({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(e,o),view:i});return this._computationHandles.add(a,e),s}_setupOffsetManipulator(e){const{view:t}=this,i=cn(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:e.dimension}),n=mn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupHeadingManipulator(e){const{view:t}=this,i=et(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=hn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupRotationManipulator(e){const{view:t}=this,i=et(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=gn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupMeasureTypeManipulator(e,t){const{view:i}=this,n=un(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:e.dimension}),s=yn(n,{computation:e,manipulatorMeasureType:t,view:i});return this._computationHandles.add(s,e),n}_updateManipulators(e,t,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=i,{start:o,end:l,offset:r,heading:u,rotation:m}=t,h=s===e,f=se(e),{dimension:w}=e;for(const M of t.values()){const E=f&&g(n)&&(g(a)||M===a);M===r?(M.available=E,M.selected=h):M.available=E&&h}if(!f)return;p(this._computeConstraint(e))?t.forEachMeasureTypeManipulator(M=>M.available=!1):t.manipulatorForMeasureType(w.measureType).available=!1;for(const M of[u,m])w.measureType===y.Direct&&w.offset!==0||(M.available=!1);Ee(e)?m.available=!1:u.available=!1;const{geometry:P}=e;o.renderLocation=P.directSegment.startRenderSpace,l.renderLocation=P.directSegment.endRenderSpace;const{renderCoordsHelper:O}=this.view;vn(r,P,O),u.available&&Sn(u,e,O),m.available&&Mn(m,e,O),t.forEachMeasureTypeManipulator((M,E)=>{M.available&&bn(M,e,E,O)})}_updateManipulatorStyle(e){const t=Tn(e),i=Fe(e),n={lineSizePt:e,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:a,rotation:o}of this._computationManipulators.values())s.radius=i/2,tt(a,n),tt(o,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:t}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(e,t){const{view:i}=this,n=ge(e);"startPoint"in t&&(n.elevationAlignedStartPoint=t.startPoint),"endPoint"in t&&(n.elevationAlignedEndPoint=t.endPoint);const s=fe(n,i.renderCoordsHelper);if(g(s))return;const a=this._computeConstraint({...n,geometry:s});xt(e,t,{...n,constraint:a,unconstrainedGeometry:s,view:i}),e===this._stagedComputation&&this._updateStagedDimensionOffset(e)}_updateStagedDimensionOffset(e){if(g(e.geometry))return;e.geometry.directSegment.eval(.5,it);const t=this.view.state.camera.computeRenderPixelSizeAt(it);e.dimension.offset=v.initialOffsetPx*t}_computeConstraint(e){return zn(An(e,this._snappingManager.options),this.view)}get testInfo(){const e=t=>this.analysisViewData.computations.find(i=>i.dimension===t);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=D.Occlude,this.manipulators.forEach(({manipulator:t})=>{for(const{geometry:i}of t.renderObjects)i.material.setParameters({renderOccluded:D.Occlude})})},getManipulatorsForDimension:t=>this._computationManipulators.get(e(t)),getComputationForDimension:t=>e(t),getConstraintForDimension:t=>{const i=e(t);return p(i)?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function Me(){const{color:e,opacity:t}=v.offsetManipulator;return new Y({color:[...G.toUnitRGB(e),t],width:1,renderOccluded:D.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}d([c({constructOnly:!0})],b.prototype,"analysis",void 0),d([c({constructOnly:!0})],b.prototype,"analysisViewData",void 0),d([c({constructOnly:!0})],b.prototype,"manipulators",void 0),d([c({constructOnly:!0})],b.prototype,"parentTool",void 0),d([c({constructOnly:!0,nonNullable:!0})],b.prototype,"view",void 0),d([c({readOnly:!0})],b.prototype,"updating",null),d([c()],b.prototype,"firstGrabbedManipulator",null),d([c()],b.prototype,"hasGrabbedManipulators",null),d([c()],b.prototype,"snappingOptions",null),d([c()],b.prototype,"_stagedDimension",void 0),d([c()],b.prototype,"_activeComputation",null),d([c()],b.prototype,"_stagedComputation",null),b=d([F("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],b);const it=C();var W;(function(e){e.Ready="ready",e.Creating="creating",e.Created="created"})(W||(W={}));let T=class extends Li{constructor(e){super(e),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=v.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Jt(this.view.state.viewingMode),this._intersector.options.store=Yt.MIN,this._lengthDimensionSubTool=new b({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([Xt(this._lengthDimensionSubTool),me(()=>this._clearPointerMoveTimeout()),S(()=>this.state,e=>{e===W.Created&&this.finishToolCreation()},R),He(()=>this.firstGrabbedManipulator,e=>{this.selectedDimension=e.metadata},R),S(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),R)])}get state(){return this.analysis.dimensions.some(e=>e.type==="length")?p(this._activeSubTool)?W.Creating:W.Created:W.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(e){this.analysisViewData.selectedDimension=e}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":if(Je.cancel===e.key){if(p(this._activeSubTool)&&this._activeSubTool.removeStaged())return void e.stopPropagation();this.active||(this.selectedDimension=null)}else Je.delete.includes(e.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){p(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(g(this._activeSubTool))return;const t=this._intersectScreen(e);g(t)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),e.stopPropagation())}_doubleClickHandler(e){this.active&&(this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(this._resetPointerMoveTimeout(),g(this._activeSubTool)||this.hasFocusedManipulators)return;const t=this._intersectScreen(e);g(t)||this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_deleteKeyHandler(){p(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(e){const t=Qt(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,n=_.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){p(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Zt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(e=>{e.manipulator.state|=V}),this._prevPointerMoveTimeout=ei.setTimeout(()=>{this.manipulators.forEach(e=>{e.manipulator.state&=~V})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:e=>{this._pointerMoveTimerMs=e,this._resetPointerMoveTimeout()}}}};d([c({constructOnly:!0})],T.prototype,"view",void 0),d([c({constructOnly:!0})],T.prototype,"analysis",void 0),d([c({readOnly:!0})],T.prototype,"state",null),d([c({readOnly:!0})],T.prototype,"updating",null),d([c({readOnly:!0})],T.prototype,"cursor",null),d([c({constructOnly:!0})],T.prototype,"analysisViewData",void 0),d([c()],T.prototype,"selectedDimension",null),d([c()],T.prototype,"automaticManipulatorSelection",void 0),d([c()],T.prototype,"_activeSubTool",void 0),d([c()],T.prototype,"_lengthDimensionSubTool",void 0),T=d([F("esri.views.3d.analysis.Dimension.DimensionTool")],T);let En=class extends Oi{constructor(t,i){super(t),this._hasExternalMaterial=!1,this._renderOccluded=D.OccludeAndTransparent,this._width=1,this._color=ti(1,0,1,1),this._placement="end",this._textureId=null,this._material=i,this._hasExternalMaterial=p(i),this.applyProps(t)}setGeometryFromSegment(t,i){const n=t.endRenderSpace;this.transform=ii(In,n),this._normal=i;const{points:s}=t.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return p(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(t){this._renderOccluded=t,p(this._material)&&this._material.setParameters({renderOccluded:t})}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get normal(){return this._normal}set normal(t){this._normal=t,this.recreateGeometry()}get width(){return p(this._material)?this._material.parameters.width:this._width}set width(t){this._width=t,p(this._material)&&this._material.setParameters({width:t})}get color(){return p(this._material)?this._material.parameters.color:this._color}set color(t){this._color=ni(t),p(this._material)&&this._material.setParameters({color:this._color})}get placement(){return p(this._material)?this._material.parameters.placement:this._placement}set placement(t){this._placement=t,p(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return p(this._material)?this._material.parameters.textureId:this._textureId}set textureId(t){this._textureId=t,p(this._material)&&this._material.setParameters({textureId:t})}createExternalResources(){this._hasExternalMaterial||(this._material=new ct({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(t){for(const i of si(this.geometry,this.normal)){const n=ai(Ye(this._material),i);t.addGeometry(n)}}forEachExternalMaterial(t){this._hasExternalMaterial||t(Ye(this._material))}};const In=Ae();class Gn{set visible(t){for(const i of this._visualElements.values())i.attached=t}constructor(t){this.destroyed=!1,this._handles=new ze,this._messages=null,this._labelSegment=new N;const{analysis:i,computation:n,view:s,messages:a}=t;this.analysis=i,this.computation=n,this.view=s,this._messages=a;const o=t.visible,l={view:s,attached:o},{fontSize:r,textColor:u,textBackgroundColor:m}=i.style;this._visualElements=new Nn({marker:new En(l,t.markerMaterial),dimension:new U(l,t.dimensionLineMaterial),startOffset:new U(l,t.offsetLineMaterial),endOffset:new U(l,t.offsetLineMaterial),dimensionSmall:new U(l,t.smallDimensionLineMaterial),startOffsetSmall:new U(l,t.smallOffsetLineMaterial),endOffsetSmall:new U(l,t.smallOffsetLineMaterial),label:new gi({view:s,attached:o,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:H(r),textColor:u.clone(),backgroundColor:m.clone()})}),this._handles.add([S(()=>n.geometry,h=>{this.updateCameraDependentElements(s.state.camera,h,i.style),p(n.geometry)&&this._updateLines(n.geometry)},{...pe,equals:Te}),S(()=>n.length,h=>this._updateLabelContent(h),pe)])}destroy(){this.destroyed=!0,this._handles=ie(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(t){const i=Ze(Un,ne.Start,t.directSegment,t.dimensionSegment),n=Ze(Bn,ne.End,t.directSegment,t.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),s.dimension.setGeometryFromSegment(t.dimensionSegment),s.startOffset.setGeometryFromSegment(i),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(i),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(t,i,n){const s=this._visualElements;if(g(i)){for(const O of s.values())O.visible=!1;return}const a=t.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,jn)),o=Yi(i,a),l=o<(H(n.lineSize)*v.smallScreenLengthLineSizeFactor)**2,r=!l;s.marker.visible=r,s.dimension.visible=r,s.startOffset.visible=r,s.endOffset.visible=r,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const u=H(n.fontSize)*v.labels.minScreenLengthFontSizeFactor,{label:m}=s;if(m.visible=o>=u**2,!m.visible)return;const{dimensionSegment:h,primaryOffsetAxis:f}=i,{offset:w}=this.computation.dimension,P=(Math.sign(w)>=0?1:-1)*Fn(n)*a;Bi(this._labelSegment,h,f,P),m.updateLabelPosition()}updateLabelStyle(t){const{label:i}=this._visualElements;i.fontSize=H(t.fontSize),i.textColor=t.textColor,i.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(t){const{label:i}=this._visualElements;g(t)||g(this._messages)?i.text="":i.text=hi(this._messages,t,t.unit)}}function Fn(e){return 1.5*H(e.fontSize)+v.labels.marginPx+H(e.lineSize/2)}const Un=new N,Bn=new N,jn=C();class Nn{constructor(t){this.marker=t.marker,this.dimension=t.dimension,this.startOffset=t.startOffset,this.endOffset=t.endOffset,this.dimensionSmall=t.dimensionSmall,this.startOffsetSmall=t.startOffsetSmall,this.endOffsetSmall=t.endOffsetSmall,this.label=t.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let Wn=class{constructor(t,i){this._textures=t,this._textureRepository=i,this._texturesByPrimitive=new Map}acquire(t){if(!this._texturesByPrimitive.has(t)){const i=oi(this._textures,t),n=new Fi(this._textureRepository,i.texture.id);return this._texturesByPrimitive.set(t,{result:i,reference:n}),i.texture}return this._texturesByPrimitive.get(t).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:t,reference:i})=>{i.dispose(),t.release()}),this._texturesByPrimitive.clear()}},I=class extends ae{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(e){super(e),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new ct({width:1,anchor:ri.Tip,color:J,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:D.OccludeAndTransparent}),this._dimensionLineMaterial=new Y({width:1,color:J,renderOccluded:D.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new Y({width:1,color:J,renderOccluded:D.OccludeAndTransparent,stipplePattern:he(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new Y({width:1,color:J,renderOccluded:D.OccludeAndTransparent}),this._smallOffsetLineMaterial=new Y({width:1,color:J,renderOccluded:D.OccludeAndTransparent,stipplePattern:he(5),stippleScaleWithLineWidth:!0})}initialize(){var i;const e=(i=this.view.sharedSymbolResources)==null?void 0:i.textures;if(p(e)){const{textureRepository:n}=this.view._stage.renderView,s=new Wn(e,n),a=s.acquire("triangle");this.addHandles(me(()=>s.destroy())),this._markerMaterial.setParameters({textureId:a.id})}for(const n of this._lineMaterials())this.view._stage.add(n),this.addHandles(me(()=>{this.view._stage.remove(n),n.dispose()}));const{computations:t}=this.analysisViewData;for(const n of t)this._addComputation(n);this.addHandles([t.on("change",({added:n,removed:s})=>{for(const a of s)this._removeComputation(a);for(const a of n)this._addComputation(a)}),S(()=>G.toUnitRGBA(this.analysis.style.color),n=>{for(const s of this._lineMaterials())s.setParameters({color:n})},R),S(()=>this.analysis.style.lineSize,n=>{const s=H(n);this._markerMaterial.setParameters({width:s*v.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:s,markerParameters:this._markerMaterial.parameters});const a=Math.max(s*v.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:a})},R),S(()=>({camera:this.view.state.camera,style:qn(this.analysis)}),({camera:n,style:s})=>{for(const[a,o]of this._dimensionVisualizations)o.updateCameraDependentElements(n,a.geometry,s),o.updateLabelStyle(s)}),S(()=>this.visible,n=>{for(const s of this._dimensionVisualizations.values())s.visible=n})]),this.addHandles([li(()=>this._updateMessageBundle()),He(()=>!this.loadingMessages,()=>{for(const n of this._dimensionVisualizations.values())n.updateUnitsMessages(this._messages)},Oe)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(e=>{e.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const e of this._lineMaterials())e.setParameters({renderOccluded:D.Occlude})}}}_addComputation(e){this._dimensionVisualizations.has(e)||this._dimensionVisualizations.set(e,new Gn({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(e){const t=this._dimensionVisualizations.get(e);g(t)||(t.destroy(),this._dimensionVisualizations.delete(e))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await di("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function qn(e){const{fontSize:t,lineSize:i,textColor:n,textBackgroundColor:s}=e.style;return{fontSize:t,lineSize:i,textBackgroundColor:s.clone(),textColor:n.clone()}}d([c({constructOnly:!0})],I.prototype,"analysisViewData",void 0),d([c({constructOnly:!0,nonNullable:!0})],I.prototype,"view",void 0),d([c()],I.prototype,"analysis",null),d([c()],I.prototype,"visible",null),d([c()],I.prototype,"loadingMessages",void 0),I=d([F("esri.views.3d.analysis.Dimension.DimensionVisualization")],I);let X=class extends ae{constructor(e){super(e),this.dimension=null,this.length=null}};d([c({constructOnly:!0,nonNullable:!0})],X.prototype,"dimension",void 0),d([c()],X.prototype,"length",void 0),X=d([F("esri.views.3d.analysis.LengthDimensionResult")],X);const Kn=X;let x=class extends ae{constructor(e){super(e),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(e){const{dimension:t,...i}=e;return{result:new Kn({dimension:t}),...i}}initialize(){this.addHandles([S(()=>this.dimension.startPoint,e=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(e),R),S(()=>this.dimension.endPoint,e=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(e),R)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([c({constructOnly:!0,nonNullable:!0})],x.prototype,"result",void 0),d([c({constructOnly:!0,nonNullable:!0})],x.prototype,"projectAndAlignPoint",void 0),d([c()],x.prototype,"dimension",null),d([c()],x.prototype,"length",null),d([c()],x.prototype,"geometry",void 0),d([c()],x.prototype,"unconstrainedGeometry",void 0),d([c()],x.prototype,"elevationAlignedStartPoint",void 0),d([c()],x.prototype,"elevationAlignedEndPoint",void 0),d([c()],x.prototype,"preConstraintProperties",void 0),d([c()],x.prototype,"previousConstraint",void 0),x=d([F("esri.views.3d.analysis.LengthDimensionComputation")],x);const Jn=e=>{let t=class extends e{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new Re}createLengthDimensions(i){throw new Error("Method not implemented.")}};return d([c({constructOnly:!0})],t.prototype,"view",void 0),d([c({constructOnly:!0,nonNullable:!0})],t.prototype,"analysis",void 0),d([c()],t.prototype,"tool",void 0),d([c({readOnly:!0})],t.prototype,"results",null),d([c()],t.prototype,"selectedDimension",void 0),d([c()],t.prototype,"interactive",void 0),d([c()],t.prototype,"visible",void 0),t=d([F("esri.views.analysis.DimensionAnalysisView")],t),t};let $=class extends Jn(ci(ae)){constructor(e){super(e),this.type="dimension-view-3d",this.tool=null,this.computations=new Re,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(g(e))return null;const{spatialReference:t,elevationProvider:i}=this.view,n=Ti(e,t,i);return g(n)&&xi(this.analysis,e.spatialReference,st.getLogger(this.declaredClass)),n},this.addHandles([Ei(this,T),Xe(()=>this.analysis.dimensions,"after-add",e=>this._onDimensionAdd(e.item),{onListenerAdd:e=>{for(const t of e)this._onDimensionAdd(t)},onListenerRemove:()=>{this._onDimensionsClear()}}),Xe(()=>this.analysis.dimensions,"after-remove",e=>this._onDimensionRemove(e.item))]),this._analysisVisualization=new I({analysisViewData:this,view:this.view}),this._analysisController=new B({analysisViewData:this,view:this.view})}destroy(){this._placementTask=Qe(this._placementTask),this._analysisVisualization=ie(this._analysisVisualization),Ii(this)}get updating(){var e;return((e=this._analysisVisualization)==null?void 0:e.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(e=>this._dimensionsToComputations.get(e).result)}get selectedComputation(){const{selectedDimension:e}=this;return g(e)?null:this._dimensionsToComputations.get(e)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(e){return this.selectedDimension=null,this._placementTask=Qe(this._placementTask),this._placementTask=Gi(this,e),this._placementTask.promise}_onDimensionAdd(e){const{computations:t,_dimensionsToComputations:i}=this;if(i.has(e))return;const n=new x({dimension:e,projectAndAlignPoint:this._projectAndAlignPoint});t.add(n),i.set(e,n)}_onDimensionRemove(e){const{computations:t,_dimensionsToComputations:i}=this,n=t.findIndex(a=>a.dimension===e),s=t.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),t.removeAt(n),i.delete(e),ie(s)}_onDimensionsClear(){this.computations.drain(e=>e.destroy()),this._dimensionsToComputations.clear()}};d([c({readOnly:!0})],$.prototype,"type",void 0),d([c()],$.prototype,"tool",void 0),d([c()],$.prototype,"updating",null),d([c({readOnly:!0})],$.prototype,"results",null),d([c({readOnly:!0})],$.prototype,"computations",void 0),d([c()],$.prototype,"selectedDimension",void 0),d([c()],$.prototype,"selectedComputation",null),d([c()],$.prototype,"_analysisVisualization",void 0),d([c()],$.prototype,"_analysisController",void 0),d([c()],$.prototype,"_dimensionsToComputations",void 0),d([c()],$.prototype,"_placementTask",void 0),$=d([F("esri.views.3d.analysis.DimensionAnalysisView3D")],$);const As=$;export{As as default};
